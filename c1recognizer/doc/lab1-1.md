# C1 语言的词法分析器

宋小牛 PB15000301

##主要任务

根据 C1 语言 的词法描述，修改并完善课程实验软件包中 C1 的词法描述文件 c1recognizer/grammar/C1Lexer.g4，利用 ANTLR v4 节介绍的 ANTLR 的使用方法编译和测试你的分析器。请编写若干个正确的和错误的C1程序作为测试程序，来测试你所构造的C1 词法分析器。测试输入应置于test/test_cases/lexer中。

##重点与难点

请在 Lexer 实现中特别注意行尾的处理，正确地处理 CRLF 和 LF 两种换行
你需要仔细编写单行注释和多行注释的词法规则，并构造各种测试例子进行测试

[TOC]

##词法描述文件

大括号等token直接填写即可，见`grammer/C1Lexer.g4`

### Identifier

`_`与字母开头，下划线字母数字组成的串

```antlr
Identifier: [_a-zA-Z][_0-9a-zA-Z]* ;
```

### Comment

* 换行符

换行为`\r\n`或`\n`，应为`'\r'? '\n'`

* 块注释

以`/*`开头，`*/`结尾的串，匹配第一个`*/`作为结尾，故使用non-greedy many

```
Comment_Block: '/*' .*? '*/' -> skip;
```

* 行注释

以`//`开头，到第一个行尾字符非`\`的行结束(包括该行)

从而注释应是这样一串：


> //换行
>
> 或
>
> // .... 非\字符 换行

`//`与换行间的内容应越少越好，故应用non-greedy版本

```
Comment: '//' .*? ~'\\' '\r'? '\n'
```

这样将不能识别空注释，故加上`??`，解答为

```
Comment: '//' (.*? ~'\\')?? '\r'? '\n'
```

## 测试

### 编译

当前目录`grammer`

```shell
antlr4 C1Lexer.g4
javac C1Lexer.java
```

### 运行

```shell
jeffery@jeffery-N551JM:~/CP/c1recognizer/grammar$ grun C1Lexer tokens -tokens ../test/test_cases/simple.c1
[@0,0:2='int',<'int'>,1:0]
[@1,4:4='i',<Identifier>,1:4]
[@2,6:6='=',<'='>,1:6]
[@3,8:8='0',<Number>,1:8]
[@4,9:9=';',<';'>,1:9]
[@5,11:14='void',<'void'>,2:0]
[@6,16:19='main',<Identifier>,2:5]
[@7,20:20='(',<'('>,2:9]
[@8,21:21=')',<')'>,2:10]
[@9,23:23='{',<'{'>,3:0]
[@10,29:29='i',<Identifier>,4:4]
[@11,31:31='=',<'='>,4:6]
[@12,33:33='1',<Number>,4:8]
[@13,34:34=';',<';'>,4:9]
[@14,36:36='}',<'}'>,5:0]
[@15,38:37='<EOF>',<EOF>,6:0]
jeffery@jeffery-N551JM:~/CP/c1recognizer/grammar$ grun C1Lexer tokens -tokens ../test/test_cases/declarations.c1 
[@0,1:3='int',<'int'>,2:0]
[@1,5:6='v1',<Identifier>,2:4]
[@2,7:7=',',<','>,2:6]
[@3,9:10='v2',<Identifier>,2:8]
[@4,12:12='=',<'='>,2:11]
[@5,14:14='3',<Number>,2:13]
[@6,15:15=';',<';'>,2:14]
[@7,17:19='int',<'int'>,3:0]
[@8,21:22='a1',<Identifier>,3:4]
[@9,23:23='[',<'['>,3:6]
[@10,24:24='3',<Number>,3:7]
[@11,25:25=']',<']'>,3:8]
[@12,26:26=';',<';'>,3:9]
[@13,28:30='int',<'int'>,4:0]
[@14,32:33='a2',<Identifier>,4:4]
[@15,34:34='[',<'['>,4:6]
[@16,35:35='3',<Number>,4:7]
[@17,36:36=']',<']'>,4:8]
[@18,38:38='=',<'='>,4:10]
[@19,40:40='{',<'{'>,4:12]
[@20,41:41='1',<Number>,4:13]
[@21,42:42=',',<','>,4:14]
[@22,44:44='2',<Number>,4:16]
[@23,45:45='}',<'}'>,4:17]
[@24,46:46=';',<';'>,4:18]
[@25,48:50='int',<'int'>,5:0]
[@26,52:53='a3',<Identifier>,5:4]
[@27,54:54='[',<'['>,5:6]
[@28,55:55=']',<']'>,5:7]
[@29,57:57='=',<'='>,5:9]
[@30,59:59='{',<'{'>,5:11]
[@31,60:60='1',<Number>,5:12]
[@32,61:61=',',<','>,5:13]
[@33,63:63='2',<Number>,5:15]
[@34,64:64=',',<','>,5:16]
[@35,66:66='3',<Number>,5:18]
[@36,67:67=',',<','>,5:19]
[@37,69:69='4',<Number>,5:21]
[@38,70:70='}',<'}'>,5:22]
[@39,71:71=';',<';'>,5:23]
[@40,73:77='const',<'const'>,6:0]
[@41,79:81='int',<'int'>,6:6]
[@42,83:84='c1',<Identifier>,6:10]
[@43,86:86='=',<'='>,6:13]
[@44,88:88='3',<Number>,6:15]
[@45,89:89=',',<','>,6:16]
[@46,91:92='a4',<Identifier>,6:18]
[@47,93:93='[',<'['>,6:20]
[@48,94:94='2',<Number>,6:21]
[@49,95:95=']',<']'>,6:22]
[@50,97:97='=',<'='>,6:24]
[@51,99:99='{',<'{'>,6:26]
[@52,100:100='1',<Number>,6:27]
[@53,101:101=',',<','>,6:28]
[@54,103:103='2',<Number>,6:30]
[@55,104:104='}',<'}'>,6:31]
[@56,105:105=';',<';'>,6:32]
[@57,108:111='void',<'void'>,8:0]
[@58,113:116='main',<Identifier>,8:5]
[@59,117:117='(',<'('>,8:9]
[@60,118:118=')',<')'>,8:10]
[@61,120:120='{',<'{'>,9:0]
[@62,126:128='int',<'int'>,10:4]
[@63,130:131='v1',<Identifier>,10:8]
[@64,132:132=',',<','>,10:10]
[@65,134:135='v2',<Identifier>,10:12]
[@66,137:137='=',<'='>,10:15]
[@67,139:139='3',<Number>,10:17]
[@68,140:140=';',<';'>,10:18]
[@69,146:148='int',<'int'>,11:4]
[@70,150:151='a1',<Identifier>,11:8]
[@71,152:152='[',<'['>,11:10]
[@72,153:153='3',<Number>,11:11]
[@73,154:154=']',<']'>,11:12]
[@74,155:155=';',<';'>,11:13]
[@75,161:163='int',<'int'>,12:4]
[@76,165:166='a2',<Identifier>,12:8]
[@77,167:167='[',<'['>,12:10]
[@78,168:168='3',<Number>,12:11]
[@79,169:169=']',<']'>,12:12]
[@80,171:171='=',<'='>,12:14]
[@81,173:173='{',<'{'>,12:16]
[@82,174:174='1',<Number>,12:17]
[@83,175:175=',',<','>,12:18]
[@84,177:177='2',<Number>,12:20]
[@85,178:178='}',<'}'>,12:21]
[@86,179:179=';',<';'>,12:22]
[@87,185:187='int',<'int'>,13:4]
[@88,189:190='a3',<Identifier>,13:8]
[@89,191:191='[',<'['>,13:10]
[@90,192:192=']',<']'>,13:11]
[@91,194:194='=',<'='>,13:13]
[@92,196:196='{',<'{'>,13:15]
[@93,197:197='1',<Number>,13:16]
[@94,198:198=',',<','>,13:17]
[@95,200:200='2',<Number>,13:19]
[@96,201:201=',',<','>,13:20]
[@97,203:203='3',<Number>,13:22]
[@98,204:204=',',<','>,13:23]
[@99,206:206='4',<Number>,13:25]
[@100,207:207='}',<'}'>,13:26]
[@101,208:208=';',<';'>,13:27]
[@102,214:218='const',<'const'>,14:4]
[@103,220:222='int',<'int'>,14:10]
[@104,224:225='c1',<Identifier>,14:14]
[@105,227:227='=',<'='>,14:17]
[@106,229:229='3',<Number>,14:19]
[@107,230:230=',',<','>,14:20]
[@108,232:233='a4',<Identifier>,14:22]
[@109,234:234='[',<'['>,14:24]
[@110,235:235='2',<Number>,14:25]
[@111,236:236=']',<']'>,14:26]
[@112,238:238='=',<'='>,14:28]
[@113,240:240='{',<'{'>,14:30]
[@114,241:241='1',<Number>,14:31]
[@115,242:242=',',<','>,14:32]
[@116,244:244='2',<Number>,14:34]
[@117,245:245='}',<'}'>,14:35]
[@118,246:246=';',<';'>,14:36]
[@119,248:248='}',<'}'>,15:0]
[@120,250:249='<EOF>',<EOF>,16:0]
jeffery@jeffery-N551JM:~/CP/c1recognizer/grammar$ grun C1Lexer tokens -tokens ../test/test_cases/expr.c1 
[@0,0:4='const',<'const'>,1:0]
[@1,6:8='int',<'int'>,1:6]
[@2,10:11='e1',<Identifier>,1:10]
[@3,13:13='=',<'='>,1:13]
[@4,15:15='1',<Number>,1:15]
[@5,17:17='+',<'+'>,1:17]
[@6,19:19='2',<Number>,1:19]
[@7,20:20=';',<';'>,1:20]
[@8,22:26='const',<'const'>,2:0]
[@9,28:30='int',<'int'>,2:6]
[@10,32:33='e2',<Identifier>,2:10]
[@11,35:35='=',<'='>,2:13]
[@12,37:37='1',<Number>,2:15]
[@13,39:39='-',<'-'>,2:17]
[@14,41:41='2',<Number>,2:19]
[@15,42:42=';',<';'>,2:20]
[@16,44:48='const',<'const'>,3:0]
[@17,50:52='int',<'int'>,3:6]
[@18,54:55='e3',<Identifier>,3:10]
[@19,57:57='=',<'='>,3:13]
[@20,59:59='1',<Number>,3:15]
[@21,61:61='*',<'*'>,3:17]
[@22,63:63='3',<Number>,3:19]
[@23,64:64=';',<';'>,3:20]
[@24,66:70='const',<'const'>,4:0]
[@25,72:74='int',<'int'>,4:6]
[@26,76:77='e4',<Identifier>,4:10]
[@27,79:79='=',<'='>,4:13]
[@28,81:81='4',<Number>,4:15]
[@29,83:83='/',<'/'>,4:17]
[@30,85:85='2',<Number>,4:19]
[@31,86:86=';',<';'>,4:20]
[@32,88:92='const',<'const'>,5:0]
[@33,94:96='int',<'int'>,5:6]
[@34,98:99='e5',<Identifier>,5:10]
[@35,101:101='=',<'='>,5:13]
[@36,103:103='1',<Number>,5:15]
[@37,105:105='%',<'%'>,5:17]
[@38,107:107='2',<Number>,5:19]
[@39,108:108=';',<';'>,5:20]
[@40,110:114='const',<'const'>,6:0]
[@41,116:118='int',<'int'>,6:6]
[@42,120:121='e6',<Identifier>,6:10]
[@43,123:123='=',<'='>,6:13]
[@44,125:125='+',<'+'>,6:15]
[@45,126:126='1',<Number>,6:16]
[@46,127:127=';',<';'>,6:17]
[@47,129:133='const',<'const'>,7:0]
[@48,135:137='int',<'int'>,7:6]
[@49,139:140='e7',<Identifier>,7:10]
[@50,142:142='=',<'='>,7:13]
[@51,144:144='-',<'-'>,7:15]
[@52,145:145='1',<Number>,7:16]
[@53,146:146=';',<';'>,7:17]
[@54,148:152='const',<'const'>,8:0]
[@55,154:156='int',<'int'>,8:6]
[@56,158:159='e8',<Identifier>,8:10]
[@57,161:161='=',<'='>,8:13]
[@58,163:163='1',<Number>,8:15]
[@59,165:165='+',<'+'>,8:17]
[@60,167:167='2',<Number>,8:19]
[@61,169:169='*',<'*'>,8:21]
[@62,171:171='3',<Number>,8:23]
[@63,172:172=';',<';'>,8:24]
[@64,174:178='const',<'const'>,9:0]
[@65,180:182='int',<'int'>,9:6]
[@66,184:185='e9',<Identifier>,9:10]
[@67,187:187='=',<'='>,9:13]
[@68,189:189='(',<'('>,9:15]
[@69,190:190='1',<Number>,9:16]
[@70,192:192='+',<'+'>,9:18]
[@71,194:194='2',<Number>,9:20]
[@72,195:195=')',<')'>,9:21]
[@73,197:197='*',<'*'>,9:23]
[@74,199:199='3',<Number>,9:25]
[@75,200:200=';',<';'>,9:26]
[@76,202:206='const',<'const'>,10:0]
[@77,208:210='int',<'int'>,10:6]
[@78,212:214='e10',<Identifier>,10:10]
[@79,215:215='[',<'['>,10:13]
[@80,216:216=']',<']'>,10:14]
[@81,218:218='=',<'='>,10:16]
[@82,220:220='{',<'{'>,10:18]
[@83,221:222='e1',<Identifier>,10:19]
[@84,223:223=',',<','>,10:21]
[@85,225:226='e2',<Identifier>,10:23]
[@86,227:227=',',<','>,10:25]
[@87,229:230='e3',<Identifier>,10:27]
[@88,231:231='}',<'}'>,10:29]
[@89,232:232=';',<';'>,10:30]
[@90,234:238='const',<'const'>,11:0]
[@91,240:242='int',<'int'>,11:6]
[@92,244:246='e11',<Identifier>,11:10]
[@93,248:248='=',<'='>,11:14]
[@94,250:252='e10',<Identifier>,11:16]
[@95,253:253='[',<'['>,11:19]
[@96,254:255='e1',<Identifier>,11:20]
[@97,256:256=']',<']'>,11:22]
[@98,257:257=';',<';'>,11:23]
[@99,259:258='<EOF>',<EOF>,12:0]
jeffery@jeffery-N551JM:~/CP/c1recognizer/grammar$ grun C1Lexer tokens -tokens ../test/test_cases/lexical_tokens.c1 
[@0,0:3='void',<'void'>,1:0]
[@1,5:8='main',<Identifier>,1:5]
[@2,9:9='(',<'('>,1:9]
[@3,10:10=')',<')'>,1:10]
[@4,12:12='{',<'{'>,1:12]
[@5,18:22='const',<'const'>,2:4]
[@6,24:26='int',<'int'>,2:10]
[@7,28:28='v',<Identifier>,2:14]
[@8,29:29='[',<'['>,2:15]
[@9,30:30='1',<Number>,2:16]
[@10,31:31=']',<']'>,2:17]
[@11,33:33='=',<'='>,2:19]
[@12,35:35='{',<'{'>,2:21]
[@13,36:36='1',<Number>,2:22]
[@14,37:37='}',<'}'>,2:23]
[@15,38:38=';',<';'>,2:24]
[@16,65:67='int',<'int'>,3:4]
[@17,69:69='i',<Identifier>,3:8]
[@18,71:71='=',<'='>,3:10]
[@19,73:73='v',<Identifier>,3:12]
[@20,74:74='[',<'['>,3:13]
[@21,75:75='0',<Number>,3:14]
[@22,76:76=']',<']'>,3:15]
[@23,77:77=';',<';'>,3:16]
[@24,116:117='if',<'if'>,5:4]
[@25,118:118='(',<'('>,5:6]
[@26,119:119='i',<Identifier>,5:7]
[@27,121:121='>',<'>'>,5:9]
[@28,123:123='0',<Number>,5:11]
[@29,124:124=')',<')'>,5:12]
[@30,126:126='i',<Identifier>,5:14]
[@31,128:128='=',<'='>,5:16]
[@32,130:130='1',<Number>,5:18]
[@33,131:131=';',<';'>,5:19]
[@34,137:140='else',<'else'>,6:4]
[@35,142:142='i',<Identifier>,6:9]
[@36,144:144='=',<'='>,6:11]
[@37,146:146='-',<'-'>,6:13]
[@38,147:147='1',<Number>,6:14]
[@39,148:148=';',<';'>,6:15]
[@40,154:154='i',<Identifier>,7:4]
[@41,156:156='=',<'='>,7:6]
[@42,158:158='(',<'('>,7:8]
[@43,159:159='i',<Identifier>,7:9]
[@44,161:161='+',<'+'>,7:11]
[@45,163:163='1',<Number>,7:13]
[@46,165:165='-',<'-'>,7:15]
[@47,167:167='1',<Number>,7:17]
[@48,168:168=')',<')'>,7:18]
[@49,170:170='*',<'*'>,7:20]
[@50,172:172='3',<Number>,7:22]
[@51,174:174='/',<'/'>,7:24]
[@52,176:176='2',<Number>,7:26]
[@53,178:178='%',<'%'>,7:28]
[@54,180:180='3',<Number>,7:30]
[@55,181:181=';',<';'>,7:31]
[@56,187:191='while',<'while'>,8:4]
[@57,193:193='(',<'('>,8:10]
[@58,194:194='i',<Identifier>,8:11]
[@59,196:196='>',<'>'>,8:13]
[@60,198:198='0',<Number>,8:15]
[@61,199:199=')',<')'>,8:16]
[@62,201:201='i',<Identifier>,8:18]
[@63,203:203='=',<'='>,8:20]
[@64,205:205='i',<Identifier>,8:22]
[@65,207:207='-',<'-'>,8:24]
[@66,209:209='1',<Number>,8:26]
[@67,210:210=';',<';'>,8:27]
[@68,216:220='while',<'while'>,9:4]
[@69,222:222='(',<'('>,9:10]
[@70,223:223='i',<Identifier>,9:11]
[@71,225:225='<',<'<'>,9:13]
[@72,227:227='0',<Number>,9:15]
[@73,228:228=')',<')'>,9:16]
[@74,230:230='i',<Identifier>,9:18]
[@75,232:232='=',<'='>,9:20]
[@76,234:234='i',<Identifier>,9:22]
[@77,236:236='-',<'-'>,9:24]
[@78,238:238='1',<Number>,9:26]
[@79,239:239=';',<';'>,9:27]
[@80,245:249='while',<'while'>,10:4]
[@81,251:251='(',<'('>,10:10]
[@82,252:252='i',<Identifier>,10:11]
[@83,254:255='==',<'=='>,10:13]
[@84,257:257='0',<Number>,10:16]
[@85,258:258=')',<')'>,10:17]
[@86,260:260='i',<Identifier>,10:19]
[@87,262:262='=',<'='>,10:21]
[@88,264:264='i',<Identifier>,10:23]
[@89,266:266='-',<'-'>,10:25]
[@90,268:268='1',<Number>,10:27]
[@91,269:269=';',<';'>,10:28]
[@92,299:303='while',<'while'>,12:4]
[@93,305:305='(',<'('>,12:10]
[@94,306:306='i',<Identifier>,12:11]
[@95,308:309='!=',<'!='>,12:13]
[@96,311:311='0',<Number>,12:16]
[@97,312:312=')',<')'>,12:17]
[@98,314:314='i',<Identifier>,12:19]
[@99,316:316='=',<'='>,12:21]
[@100,318:318='i',<Identifier>,12:23]
[@101,320:320='-',<'-'>,12:25]
[@102,322:322='1',<Number>,12:27]
[@103,323:323=';',<';'>,12:28]
[@104,329:333='while',<'while'>,13:4]
[@105,335:335='(',<'('>,13:10]
[@106,336:336='i',<Identifier>,13:11]
[@107,338:339='>=',<'>='>,13:13]
[@108,341:341='0',<Number>,13:16]
[@109,342:342=')',<')'>,13:17]
[@110,344:344='i',<Identifier>,13:19]
[@111,346:346='=',<'='>,13:21]
[@112,348:348='i',<Identifier>,13:23]
[@113,350:350='-',<'-'>,13:25]
[@114,352:352='1',<Number>,13:27]
[@115,353:353=';',<';'>,13:28]
[@116,359:363='while',<'while'>,14:4]
[@117,365:365='(',<'('>,14:10]
[@118,366:366='i',<Identifier>,14:11]
[@119,368:369='<=',<'<='>,14:13]
[@120,371:371='0',<Number>,14:16]
[@121,372:372=')',<')'>,14:17]
[@122,374:374='i',<Identifier>,14:19]
[@123,376:376='=',<'='>,14:21]
[@124,378:378='i',<Identifier>,14:23]
[@125,380:380='-',<'-'>,14:25]
[@126,382:382='1',<Number>,14:27]
[@127,383:383=';',<';'>,14:28]
[@128,389:389='i',<Identifier>,15:4]
[@129,391:391='=',<'='>,15:6]
[@130,393:402='0x1234FeDc',<Number>,15:8]
[@131,403:403=';',<';'>,15:18]
[@132,405:405='}',<'}'>,16:0]
[@133,406:405='<EOF>',<EOF>,16:1]
```
可见token均被正确识别，注释、tab回车空格也均被忽略

现修改`../test/test_cases/lexical_tokens.c1`为`my_test.c1`

```c++
void main() {
    const int v[1] = {1}; // line comment test
    int i = v[0]; // line comment 
    cross line \
    if(i > 0) i = 1;
    else i = -1;
    i = (i + 1 - 1) * 3 / 2 % 3;
    while (i > 0) i = i - 1;
    while (i < 0) i = i - 1;
    while (i == 0) i = i - 1; /* block
    comment */
    while (i != 0) i = i - 1; */
    while (i >= 0) i = i - 1;
    while (i <= 0) i = i - 1;
    i = 0x1234FeDc;
}
```

结果如下

```shell
line 4:15 token recognition error at: '\'
...
[@24,100:104='cross',<Identifier>,4:4]
[@25,106:109='line',<Identifier>,4:10]
...
[@106,324:324='*',<'*'>,12:30]
[@107,325:325='/',<'/'>,12:31]
...
```

可见行`cross line`被识别为非注释，独立的块注释结尾`*/`被识别为乘号和除号。词法分析阶段能识别出的错误是非常有限的，仅当串不满足任何一个token才会报错。